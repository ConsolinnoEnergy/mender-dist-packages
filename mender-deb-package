#/bin/bash

set -ex

show_help_and_exit() {
  cat << EOF

Usage: $0 mender-version

NOTE: The script expects an /output directory where to store the generated packages. If
running it from a container, create a volume for such directory

EOF
  exit 1
}

version=""

while (( "$#" )); do
  case "$1" in
    -*)
      echo "Error: unsupported option $1"
      show_help_and_exit_error
      ;;
    *)
      version="$1"
      shift
      ;;
  esac
done

if [ -z "$version" ]; then
	show_help_and_exit
fi

if [ ! -d "/output" ]; then
  echo "Error: /output directory doesn't exist"
  show_help_and_exit
fi

#TODO: find a way to take this from the Changelog itself
dch --create -v ${version}-1 --package mender-client "Release ${version}. See online docs for Changelog"

# Build deb package
dpkg-buildpackage -aarmhf -us -uc -b

# Copy package files to /output
for file in $(find ../ -maxdepth 1 -type f); do
  cp ${file} /output
done
